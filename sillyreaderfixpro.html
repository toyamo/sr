<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SillyTavern èŠå¤©æ—¥å¿—é˜…è¯»å™¨</title>
    <style id="baseStyles">
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #0f3460;
            --text-primary: #eaeaea;
            --text-secondary: #a0a0a0;
            --accent: #e94560;
            --accent-hover: #ff6b6b;
            --user-bg: #2d4a3e;
            --char-bg: #3d2a4a;
            --border-color: #333;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);

            --quote-color: #99cc99;
            --em-color: #ffcc00;
            --strong-color: #ff9966;
            --del-color: #888888;
            --code-bg: rgba(0, 0, 0, 0.3);
            --code-color: #f0f0f0;

            --main-font: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--main-font);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        body.has-bg {
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        body.has-bg::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(22, 33, 62, 0.85);
            z-index: -1;
        }

        .navbar {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 60px;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
            box-shadow: var(--shadow);
        }

        .navbar h1 { font-size: 1.1rem; color: var(--accent); }

        .nav-buttons { display: flex; gap: 10px; }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-family: inherit;
        }

        .btn:hover:not(:disabled) { background: var(--accent); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-small { padding: 4px 10px; font-size: 0.8rem; }
        .btn-icon {
            width: 40px; height: 40px; padding: 0;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem;
        }
        .btn-primary { background: var(--accent); }
        .btn-primary:hover:not(:disabled) { background: var(--accent-hover); }
        .btn-danger { background: #a33; }

        .sidebar {
            position: fixed;
            top: 60px; left: -340px;
            width: 340px;
            height: calc(100vh - 60px);
            background: var(--bg-secondary);
            transition: left 0.3s;
            z-index: 999;
            overflow-y: auto;
            padding: 15px;
        }

        .sidebar.open { left: 0; }

        .sidebar-overlay {
            position: fixed;
            top: 60px; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 998;
        }

        .sidebar-overlay.open { display: block; }

        .sidebar-section { margin-bottom: 20px; }

        .sidebar-section h3 {
            color: var(--accent);
            margin-bottom: 10px;
            font-size: 0.95rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .upload-compact {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-compact:hover, .upload-compact.dragover {
            border-color: var(--accent);
            background: rgba(233, 69, 96, 0.1);
        }

        .upload-compact input { display: none; }
        .upload-compact .upload-icon { font-size: 1.5rem; margin-bottom: 5px; }
        .upload-compact .upload-text { font-size: 0.85rem; color: var(--text-secondary); }

        .chat-list, .bookmark-list {
            list-style: none;
            max-height: 200px;
            overflow-y: auto;
        }

        .chat-list li, .bookmark-list li {
            padding: 10px;
            background: var(--bg-tertiary);
            margin-bottom: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .chat-list li:hover, .bookmark-list li:hover {
            background: rgba(233, 69, 96, 0.3);
        }

        .chat-list li.active { border-left: 3px solid var(--accent); }

        .list-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
        }

        .chat-info, .bookmark-info { flex: 1; overflow: hidden; }

        .chat-name, .bookmark-title {
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 3px;
            font-size: 0.9rem;
        }

        .chat-meta, .bookmark-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .bookmark-preview {
            font-size: 0.8rem;
            margin-top: 5px;
            padding: 6px;
            background: rgba(0,0,0,0.2);
            border-radius: 4px;
            border-left: 2px solid var(--accent);
            max-height: 50px;
            overflow: hidden;
            color: var(--text-secondary);
        }

        .bookmark-note {
            font-size: 0.75rem;
            color: var(--em-color);
            margin-top: 5px;
            font-style: italic;
        }

        .delete-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
            font-size: 0.9rem;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .delete-btn:hover {
            color: var(--accent);
            background: rgba(233, 69, 96, 0.1);
        }

        .cache-status {
            font-size: 0.75rem;
            color: var(--text-secondary);
            padding: 8px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cache-status .size { color: var(--accent); }

        .main-content {
            margin-top: 60px;
            padding: 20px;
            padding-bottom: 80px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        .welcome-page {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .welcome-page .icon { font-size: 4rem; margin-bottom: 20px; }
        .welcome-page h2 { color: var(--text-primary); margin-bottom: 10px; }

        #chat { display: none; }
        #chat.active { display: block; }

        .message {
            padding: 15px 20px;
            margin-bottom: 15px;
            border-radius: 12px;
            position: relative;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            background: var(--user-bg);
            margin-left: 20px;
        }

        .message.char {
            background: var(--char-bg);
            margin-right: 20px;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .message-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            overflow: hidden;
        }

        .message-sender {
            font-weight: bold;
            color: var(--accent);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .message-time {
            font-size: 0.8rem;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .message-actions {
            display: flex;
            gap: 5px;
            flex-shrink: 0;
            margin-left: 10px;
        }

        .bookmark-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px 8px;
            font-size: 1rem;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .bookmark-btn:hover {
            color: var(--accent);
            background: rgba(233, 69, 96, 0.1);
        }

        .bookmark-btn.bookmarked { color: var(--accent); }

        .message-content {
            word-break: break-word;
            line-height: 1.8;
        }

        .message-content em { color: var(--em-color); font-style: italic; }
        .message-content strong { color: var(--strong-color); font-weight: bold; }
        .message-content q { color: var(--quote-color); }
        .message-content q::before { content: '"'; }
        .message-content q::after { content: '"'; }
        .message-content del, .message-content s { color: var(--del-color); text-decoration: line-through; }

        .message-content code {
            background: var(--code-bg);
            color: var(--code-color);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
            font-size: 0.9em;
        }

        .message-content pre {
            background: var(--code-bg);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Consolas', monospace;
            margin: 10px 0;
        }

        .message-content details {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            margin: 10px 0;
            overflow: hidden;
        }

        .message-content details summary {
            cursor: pointer;
            color: var(--accent);
            font-weight: bold;
            padding: 10px 15px;
            user-select: none;
            list-style: none;
        }

        .message-content details summary::-webkit-details-marker { display: none; }

        .message-content details[open] summary {
            border-bottom: 1px solid var(--border-color);
        }

        .message-content details > *:not(summary) { padding: 10px 15px; }

        .pagination {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: 60px;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.3);
            z-index: 100;
        }

        .pagination.hidden { display: none; }

        .page-input {
            width: 60px;
            padding: 5px;
            text-align: center;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 4px;
        }

        .settings-panel {
            position: fixed;
            top: 60px; right: -520px;
            width: 520px;
            max-width: 100vw;
            height: calc(100vh - 60px);
            background: var(--bg-secondary);
            transition: right 0.3s;
            z-index: 999;
            overflow-y: auto;
            padding: 20px;
        }

        .settings-panel.open { right: 0; }

        .settings-section { margin-bottom: 25px; }
        .settings-section h3 { color: var(--accent); margin-bottom: 15px; font-size: 1rem; }

        .settings-section textarea {
            width: 100%;
            height: 180px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px;
            border-radius: 6px;
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
            resize: vertical;
        }

        .settings-section input[type="text"],
        .settings-section input[type="url"],
        .settings-section select {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: var(--text-secondary); font-size: 0.9rem; }

        .form-row { display: flex; gap: 10px; align-items: flex-end; }
        .form-row > * { flex: 1; }
        .form-row .btn { flex: 0 0 auto; }

        .switch-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .switch {
            position: relative;
            width: 48px; height: 24px;
            flex-shrink: 0;
        }

        .switch input { opacity: 0; width: 0; height: 0; }

        .switch-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--bg-primary);
            transition: 0.3s;
            border-radius: 24px;
        }

        .switch-slider:before {
            position: absolute;
            content: "";
            height: 18px; width: 18px;
            left: 3px; bottom: 3px;
            background-color: var(--text-secondary);
            transition: 0.3s;
            border-radius: 50%;
        }

        .switch input:checked + .switch-slider { background-color: var(--accent); }
        .switch input:checked + .switch-slider:before {
            transform: translateX(24px);
            background-color: white;
        }

        .switch-label { flex: 1; }
        .switch-label .title { font-weight: bold; }
        .switch-label .desc { font-size: 0.8rem; color: var(--text-secondary); }

        .scheme-list {
            list-style: none;
            margin-bottom: 15px;
            max-height: 180px;
            overflow-y: auto;
        }

        .scheme-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .scheme-item:hover { background: rgba(233, 69, 96, 0.2); }
        .scheme-item.active { border: 2px solid var(--accent); }
        .scheme-info { flex: 1; overflow: hidden; }
        .scheme-name { font-weight: bold; }
        .scheme-desc { font-size: 0.8rem; color: var(--text-secondary); }

        .regex-rule {
            background: var(--bg-tertiary);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
        }

        .regex-rule .rule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .regex-rule label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .regex-rule input[type="text"],
        .regex-rule textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 8px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 4px;
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
        }

        .regex-rule textarea { height: 50px; resize: vertical; }

        .regex-rule .rule-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .regex-rule .flags-input { width: 60px !important; }

        .tag-filters { display: flex; flex-wrap: wrap; gap: 8px; }

        .tag-filter {
            display: flex;
            align-items: center;
            gap: 5px;
            background: var(--bg-tertiary);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
        }

        .tag-filter:hover { border-color: var(--accent); }
        .tag-filter.hidden-tag { opacity: 0.5; text-decoration: line-through; }

        .no-items-msg {
            color: var(--text-secondary);
            font-size: 0.85rem;
            padding: 10px;
            text-align: center;
        }

        .tabs {
            display: flex;
            gap: 3px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            overflow-x: auto;
        }

        .tab-btn {
            padding: 6px 12px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 6px 6px 0 0;
            transition: all 0.3s;
            font-family: inherit;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .tab-btn:hover { color: var(--text-primary); background: rgba(255,255,255,0.05); }
        .tab-btn.active { color: var(--accent); background: var(--bg-tertiary); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .bookmark-popup {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            z-index: 2000;
            box-shadow: 0 4px 30px rgba(0,0,0,0.5);
            width: 400px;
            max-width: 90vw;
            display: none;
        }

        .bookmark-popup.show { display: block; }
        .bookmark-popup h4 { color: var(--accent); margin-bottom: 15px; }

        .bookmark-popup .message-preview {
            background: var(--bg-tertiary);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.9rem;
            border-left: 3px solid var(--accent);
        }

        .bookmark-popup .preview-sender {
            color: var(--accent);
            font-weight: bold;
            margin-bottom: 5px;
        }

        .bookmark-popup textarea {
            width: 100%;
            height: 80px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px;
            border-radius: 6px;
            font-family: inherit;
            resize: none;
            margin-bottom: 15px;
        }

        .bookmark-popup .actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .popup-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1999;
            display: none;
        }

        .popup-overlay.show { display: block; }

        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 2001;
            pointer-events: none;
        }

        .toast.show { opacity: 1; }

        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-overlay.open { display: flex; }

        .modal {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h3 { color: var(--accent); margin-bottom: 20px; }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }

        .font-preview {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
        }

        .font-preview-text { font-size: 1.1rem; line-height: 1.8; }

        .loaded-fonts {
            margin-top: 10px;
            padding: 10px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .loaded-fonts .font-tag {
            display: inline-block;
            background: var(--bg-primary);
            padding: 3px 8px;
            border-radius: 4px;
            margin: 3px;
            font-size: 0.8rem;
        }

        .export-options { display: flex; flex-direction: column; gap: 15px; }

        .export-format-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .format-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .format-option:hover { border-color: var(--accent); }
        .format-option.selected { border-color: var(--accent); background: rgba(233, 69, 96, 0.2); }
        .format-option input[type="radio"] { display: none; }
        .format-icon { font-size: 1.5rem; }
        .format-info { flex: 1; }
        .format-name { font-weight: bold; margin-bottom: 2px; }
        .format-desc { font-size: 0.75rem; color: var(--text-secondary); }

        .export-range {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 8px;
        }

        .export-range h4 { margin-bottom: 10px; font-size: 0.9rem; }

        .range-options { display: flex; flex-direction: column; gap: 8px; }

        .range-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .range-option:hover { background: rgba(255,255,255,0.05); }
        .range-option input[type="radio"] { accent-color: var(--accent); }

        .export-preview {
            background: var(--bg-tertiary);
            padding: 12px;
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .export-preview .preview-stat {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .export-preview .preview-stat:last-child { border-bottom: none; }
        .export-preview .stat-value { color: var(--accent); font-weight: bold; }

        .export-extra-options {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 8px;
        }

        .export-extra-options h4 { margin-bottom: 10px; font-size: 0.9rem; }

        .filter-tip {
            background: rgba(233, 69, 96, 0.1);
            border: 1px solid var(--accent);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .filter-tip strong { color: var(--accent); }
        .filter-tip code {
            background: rgba(0,0,0,0.3);
            padding: 1px 4px;
            border-radius: 3px;
            font-family: 'Consolas', monospace;
        }

        .print-header { display: none; }

        @media print {
            body { background: white !important; color: black !important; }
            .navbar, .sidebar, .settings-panel, .pagination,
            .modal-overlay, .popup-overlay, .toast,
            .message-actions, .bookmark-btn { display: none !important; }
            .main-content { margin: 0 !important; padding: 20px !important; max-width: none !important; }
            .message { background: #f5f5f5 !important; border: 1px solid #ddd !important; page-break-inside: avoid; }
            .message.user { background: #e8f5e9 !important; margin-left: 0 !important; }
            .message.char { background: #fff3e0 !important; margin-right: 0 !important; }
            .message-sender, .message-content { color: #333 !important; }
            .print-header { display: block !important; text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #333; }
        }

        @media (max-width: 768px) {
            .navbar h1 { font-size: 0.95rem; }
            .sidebar { width: 300px; left: -300px; }
            .settings-panel { width: 100%; right: -100%; }
            .main-content { padding: 15px; padding-bottom: 80px; }
            .message { margin-left: 5px !important; margin-right: 5px !important; }
            .btn { padding: 6px 12px; font-size: 0.85rem; }
            .export-format-grid { grid-template-columns: 1fr; }
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--bg-tertiary); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        .empty-state { text-align: center; padding: 15px; color: var(--text-secondary); }
    </style>
    <style id="colorStylesheet"></style>
    <style id="fontStylesheet"></style>
    <style id="customFontFaces"></style>
    <style id="customStylesheet"></style>
</head>
<body>
    <nav class="navbar">
        <div style="display: flex; align-items: center; gap: 15px;">
            <button class="btn btn-icon" id="menuBtn" title="èœå•">â˜°</button>
            <h1>ğŸ“– ST æ—¥å¿—é˜…è¯»å™¨</h1>
        </div>
        <div class="nav-buttons">
            <button class="btn btn-icon" id="exportBtn" title="å¯¼å‡º" style="display: none;">ğŸ“¥</button>
            <button class="btn btn-icon" id="settingsBtn" title="è®¾ç½®">âš™ï¸</button>
        </div>
    </nav>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-section">
            <h3>ğŸ“¤ å¯¼å…¥æ—¥å¿—</h3>
            <div class="upload-compact" id="uploadZone">
                <input type="file" id="fileInput" accept=".jsonl" multiple>
                <label for="fileInput">
                    <div class="upload-icon">ğŸ“‚</div>
                    <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼  .jsonl</div>
                </label>
            </div>
            <div class="cache-status" id="cacheStatus">
                <span>ğŸ’¾ å·²ç¼“å­˜: <span class="size" id="cacheSize">0</span></span>
                <button class="btn btn-small" onclick="clearCache()">æ¸…ç©º</button>
            </div>
        </div>

        <div class="sidebar-section">
            <h3><span>ğŸ“ èŠå¤©è®°å½•</span></h3>
            <ul class="chat-list" id="chatList"><li class="empty-state">æš‚æ— è®°å½•</li></ul>
        </div>

        <div class="sidebar-section">
            <h3>
                <span>â­ æ”¶è—å¤¹</span>
                <span style="font-size: 0.8rem; color: var(--text-secondary);" id="bookmarkCount">0</span>
            </h3>
            <ul class="bookmark-list" id="bookmarkList"><li class="empty-state">æš‚æ— æ”¶è—</li></ul>
        </div>
    </aside>

    <aside class="settings-panel" id="settingsPanel">
        <div class="tabs">
            <button class="tab-btn active" data-tab="display">ğŸ­ æ˜¾ç¤º</button>
            <button class="tab-btn" data-tab="styles">ğŸ¨ æ ·å¼</button>
            <button class="tab-btn" data-tab="fonts">ğŸ”¤ å­—ä½“</button>
            <button class="tab-btn" data-tab="regex">ğŸ”§ æ­£åˆ™</button>
            <button class="tab-btn" data-tab="data">ğŸ’¾ æ•°æ®</button>
        </div>

        <div class="tab-content active" id="tab-display">
            <div class="settings-section">
                <h3>ğŸ“‹ æ˜¾ç¤ºè®¾ç½®</h3>
                <label class="switch-group">
                    <div class="switch">
                        <input type="checkbox" id="showUserMessages" checked>
                        <span class="switch-slider"></span>
                    </div>
                    <div class="switch-label">
                        <div class="title">æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯</div>
                        <div class="desc">å…³é—­ååªæ˜¾ç¤ºè§’è‰²å›å¤</div>
                    </div>
                </label>
                <label class="switch-group">
                    <div class="switch">
                        <input type="checkbox" id="showTimestamp" checked>
                        <span class="switch-slider"></span>
                    </div>
                    <div class="switch-label"><div class="title">æ˜¾ç¤ºæ—¶é—´æˆ³</div></div>
                </label>
            </div>

            <div class="settings-section">
                <h3>ğŸ·ï¸ æ ‡ç­¾è¿‡æ»¤</h3>
                <div class="filter-tip">
                    <strong>ğŸ’¡ æ™ºèƒ½è¿‡æ»¤ï¼š</strong>æ”¯æŒå¤„ç†æœªé—­åˆæ ‡ç­¾ï¼<br>
                    â€¢ åªæœ‰ <code>&lt;/tag&gt;</code> â†’ åˆ é™¤ä»å¼€å¤´åˆ°è¯¥æ ‡ç­¾<br>
                    â€¢ åªæœ‰ <code>&lt;tag&gt;</code> â†’ åˆ é™¤åˆ°ä¸‹ä¸€ä¸ªæ ‡ç­¾ä¹‹å‰<br>
                    â€¢ æ”¯æŒä»»æ„æ ‡ç­¾åå¦‚ <code>think</code>ã€<code>thinking</code> ç­‰
                </div>
                <div class="tag-filters" id="tagFilters">
                    <span class="no-items-msg">è¯·å…ˆä¸Šä¼ æ—¥å¿—</span>
                </div>
                <button class="btn" style="margin-top: 10px; width: 100%;" onclick="refreshTags()">ğŸ”„ åˆ·æ–°æ ‡ç­¾</button>
            </div>
        </div>

        <div class="tab-content" id="tab-styles">
            <div class="settings-section">
                <h3>ğŸ“š CSS æ–¹æ¡ˆ</h3>
                <ul class="scheme-list" id="schemeList"></ul>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn" onclick="showNewSchemeModal()">â• æ–°å»º</button>
                    <button class="btn" onclick="importScheme()">ğŸ“¥ å¯¼å…¥</button>
                    <button class="btn" onclick="loadPresets()">ğŸ“‹ é¢„è®¾</button>
                </div>
            </div>

            <div class="settings-section">
                <h3>âœï¸ ç¼–è¾‘: <span id="currentSchemeName">é»˜è®¤</span></h3>
                <textarea id="customCss" placeholder="/* è‡ªå®šä¹‰CSS */"></textarea>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn btn-primary" style="flex: 1;" onclick="applyAndSaveScheme()">ğŸ’¾ ä¿å­˜</button>
                    <button class="btn" onclick="exportCurrentScheme()">ğŸ“¤ å¯¼å‡º</button>
                </div>
            </div>

            <div class="settings-section">
                <h3>ğŸ–¼ï¸ èƒŒæ™¯å›¾ç‰‡</h3>
                <div class="form-group">
                    <label>å›¾ç‰‡URL</label>
                    <div class="form-row">
                        <input type="url" id="bgImageUrl" placeholder="https://...">
                        <button class="btn" onclick="applyBackground()">åº”ç”¨</button>
                    </div>
                </div>
                <button class="btn" onclick="clearBackground()">æ¸…é™¤èƒŒæ™¯</button>
            </div>
        </div>

        <div class="tab-content" id="tab-fonts">
            <div class="settings-section">
                <h3>ğŸ”¤ å­—ä½“è®¾ç½®</h3>
                <div class="form-group">
                    <label>ç³»ç»Ÿå­—ä½“</label>
                    <select id="systemFont" onchange="applyFont()">
                        <option value="">é»˜è®¤</option>
                        <option value="'Microsoft YaHei', sans-serif">å¾®è½¯é›…é»‘</option>
                        <option value="'SimHei', sans-serif">é»‘ä½“</option>
                        <option value="'SimSun', serif">å®‹ä½“</option>
                        <option value="'KaiTi', serif">æ¥·ä½“</option>
                        <option value="'Source Han Sans SC', sans-serif">æ€æºé»‘ä½“</option>
                        <option value="'Noto Sans SC', sans-serif">Noto Sans SC</option>
                        <option value="'LXGW WenKai', serif">éœé¹œæ–‡æ¥·</option>
                        <option value="Georgia, serif">Georgia</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>è‡ªå®šä¹‰å­—ä½“åç§°</label>
                    <input type="text" id="customFontName" placeholder="è¾“å…¥å­—ä½“åç§°">
                </div>

                <div class="form-group">
                    <label>å¯¼å…¥åœ¨çº¿å­—ä½“ (CSS URL)</label>
                    <div class="form-row">
                        <input type="url" id="fontUrl" placeholder="https://fonts.googleapis.com/...">
                        <button class="btn" onclick="loadWebFont()">åŠ è½½</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>ä¸Šä¼ æœ¬åœ°å­—ä½“</label>
                    <input type="file" id="fontFile" accept=".woff,.woff2,.ttf,.otf" onchange="uploadFont(this)">
                </div>

                <div class="loaded-fonts" id="loadedFonts" style="display: none;">
                    <strong>å·²åŠ è½½å­—ä½“ï¼š</strong>
                    <div id="fontTagsContainer"></div>
                </div>

                <div class="form-group">
                    <label>å­—ä½“å¤§å°</label>
                    <div class="form-row">
                        <input type="range" id="fontSizeRange" min="12" max="28" value="16" oninput="updateFontSize(this.value)">
                        <span id="fontSizeValue" style="min-width: 50px;">16px</span>
                    </div>
                </div>

                <div class="font-preview">
                    <div style="color: var(--text-secondary); margin-bottom: 5px;">é¢„è§ˆï¼š</div>
                    <div class="font-preview-text" id="fontPreviewText">
                        The quick brown fox.<br>ä½ å¥½ä¸–ç•Œï¼<br>ã€Œå¯¹è¯ã€*åŠ¨ä½œ* **å¼ºè°ƒ**
                    </div>
                </div>

                <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="applyFont()">åº”ç”¨å­—ä½“</button>
            </div>
        </div>

        <div class="tab-content" id="tab-regex">
            <div class="settings-section">
                <h3>ğŸ”§ æ­£åˆ™è§„åˆ™</h3>
                <div id="regexRules"></div>
                <button class="btn" style="width: 100%;" onclick="addRegexRule()">+ æ·»åŠ è§„åˆ™</button>
            </div>
        </div>

        <div class="tab-content" id="tab-data">
            <div class="settings-section">
                <h3>ğŸ’¾ æ•°æ®ç®¡ç†</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="btn" style="flex: 1;" onclick="exportAllSettings()">ğŸ“¤ å¯¼å‡ºè®¾ç½®</button>
                    <button class="btn" style="flex: 1;" onclick="importAllSettings()">ğŸ“¥ å¯¼å…¥è®¾ç½®</button>
                </div>
            </div>
            <div class="settings-section">
                <h3>ğŸ—‘ï¸ æ¸…ç†</h3>
                <button class="btn btn-danger" style="width: 100%;" onclick="clearAllData()">æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
            </div>
        </div>
    </aside>

    <div class="modal-overlay" id="exportModal">
        <div class="modal" style="max-width: 550px;">
            <h3>ğŸ“¥ å¯¼å‡ºèŠå¤©è®°å½•</h3>
            <div class="export-options">
                <div>
                    <h4 style="margin-bottom: 10px; font-size: 0.9rem;">é€‰æ‹©æ ¼å¼</h4>
                    <div class="export-format-grid">
                        <label class="format-option selected" data-format="pdf">
                            <input type="radio" name="exportFormat" value="pdf" checked>
                            <span class="format-icon">ğŸ“„</span>
                            <div class="format-info"><div class="format-name">PDF</div><div class="format-desc">é€‚åˆæ‰“å°</div></div>
                        </label>
                        <label class="format-option" data-format="html">
                            <input type="radio" name="exportFormat" value="html">
                            <span class="format-icon">ğŸŒ</span>
                            <div class="format-info"><div class="format-name">HTML</div><div class="format-desc">ä¿ç•™æ ·å¼</div></div>
                        </label>
                        <label class="format-option" data-format="txt">
                            <input type="radio" name="exportFormat" value="txt">
                            <span class="format-icon">ğŸ“</span>
                            <div class="format-info"><div class="format-name">çº¯æ–‡æœ¬</div><div class="format-desc">ç®€æ´æ— æ ¼å¼</div></div>
                        </label>
                        <label class="format-option" data-format="md">
                            <input type="radio" name="exportFormat" value="md">
                            <span class="format-icon">ğŸ“‘</span>
                            <div class="format-info"><div class="format-name">Markdown</div><div class="format-desc">é€‚åˆç¼–è¾‘</div></div>
                        </label>
                        <label class="format-option" data-format="json">
                            <input type="radio" name="exportFormat" value="json">
                            <span class="format-icon">ğŸ”§</span>
                            <div class="format-info"><div class="format-name">JSON</div><div class="format-desc">åŸå§‹æ•°æ®</div></div>
                        </label>
                        <label class="format-option" data-format="epub">
                            <input type="radio" name="exportFormat" value="epub">
                            <span class="format-icon">ğŸ“š</span>
                            <div class="format-info"><div class="format-name">ç”µå­ä¹¦</div><div class="format-desc">é˜…è¯»ä½“éªŒ</div></div>
                        </label>
                    </div>
                </div>

                <div class="export-range">
                    <h4>å¯¼å‡ºèŒƒå›´</h4>
                    <div class="range-options">
                        <label class="range-option">
                            <input type="radio" name="exportRange" value="current" checked><span>å½“å‰é¡µé¢</span>
                        </label>
                        <label class="range-option">
                            <input type="radio" name="exportRange" value="all"><span>å…¨éƒ¨é¡µé¢</span>
                        </label>
                        <label class="range-option">
                            <input type="radio" name="exportRange" value="custom">
                            <span>è‡ªå®šä¹‰ï¼š</span>
                            <input type="number" id="exportPageStart" min="1" value="1" style="width: 50px; padding: 3px;">
                            <span>åˆ°</span>
                            <input type="number" id="exportPageEnd" min="1" value="1" style="width: 50px; padding: 3px;">
                            <span>é¡µ</span>
                        </label>
                    </div>
                </div>

                <div class="export-extra-options">
                    <h4>é€‰é¡¹</h4>
                    <label class="switch-group" style="margin-bottom: 5px;">
                        <input type="checkbox" id="exportIncludeTimestamp" checked>
                        <span style="margin-left: 10px;">åŒ…å«æ—¶é—´æˆ³</span>
                    </label>
                    <label class="switch-group" style="margin-bottom: 5px;">
                        <input type="checkbox" id="exportIncludeSenderName" checked>
                        <span style="margin-left: 10px;">åŒ…å«å‘é€è€…</span>
                    </label>
                    <label class="switch-group" style="margin-bottom: 0;">
                        <input type="checkbox" id="exportApplyFilters" checked>
                        <span style="margin-left: 10px;">åº”ç”¨æ ‡ç­¾ç­›é€‰</span>
                    </label>
                </div>

                <div class="export-preview" id="exportPreview">
                    <div class="preview-stat"><span>è§’è‰²</span><span class="stat-value" id="previewCharName">-</span></div>
                    <div class="preview-stat"><span>é¡µæ•°</span><span class="stat-value" id="previewPageCount">-</span></div>
                    <div class="preview-stat"><span>æ¶ˆæ¯</span><span class="stat-value" id="previewMsgCount">-</span></div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="closeModal('exportModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="executeExport()">ğŸ“¥ å¯¼å‡º</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="newSchemeModal">
        <div class="modal">
            <h3>â• æ–°å»ºæ–¹æ¡ˆ</h3>
            <div class="form-group">
                <label>åç§°</label>
                <input type="text" id="newSchemeName" placeholder="æ–¹æ¡ˆåç§°">
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="closeModal('newSchemeModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="createNewScheme()">åˆ›å»º</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="presetsModal">
        <div class="modal">
            <h3>ğŸ“‹ é¢„è®¾æ–¹æ¡ˆ</h3>
            <ul class="scheme-list" id="presetList"></ul>
            <div class="modal-actions"><button class="btn" onclick="closeModal('presetsModal')">å…³é—­</button></div>
        </div>
    </div>

    <main class="main-content" id="mainContent">
        <div class="print-header" id="printHeader">
            <h1 id="printTitle">èŠå¤©è®°å½•</h1>
            <div class="meta" id="printMeta"></div>
        </div>
        <div class="welcome-page" id="welcomePage">
            <div class="icon">ğŸ“–</div>
            <h2>æ¬¢è¿ä½¿ç”¨ ST æ—¥å¿—é˜…è¯»å™¨</h2>
            <p>ç‚¹å‡»å·¦ä¸Šè§’èœå• â˜° å¯¼å…¥èŠå¤©æ—¥å¿—</p>
        </div>
        <div id="chat"></div>
    </main>

    <div class="pagination hidden" id="pagination">
        <button class="btn" id="prevBtn">â—€ ä¸Šä¸€é¡µ</button>
        <div class="page-info">
            <input type="number" class="page-input" id="pageInput" min="1" value="1">
            <span> / <span id="totalPages">1</span></span>
        </div>
        <button class="btn" id="nextBtn">ä¸‹ä¸€é¡µ â–¶</button>
    </div>

    <div class="popup-overlay" id="popupOverlay"></div>
    <div class="bookmark-popup" id="bookmarkPopup">
        <h4>â­ æ”¶è—æ­¤æ¶ˆæ¯</h4>
        <div class="message-preview" id="bookmarkPreviewBox">
            <div class="preview-sender" id="previewSender"></div>
            <div class="preview-content" id="previewContent"></div>
        </div>
        <textarea id="bookmarkNote" placeholder="æ·»åŠ æ‰¹æ³¨ï¼ˆå¯é€‰ï¼‰..."></textarea>
        <div class="actions">
            <button class="btn btn-small" onclick="closeBookmarkPopup()">å–æ¶ˆ</button>
            <button class="btn btn-small btn-primary" onclick="confirmBookmark()">ç¡®è®¤æ”¶è—</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ==================== IndexedDB ====================
        const DB_NAME = 'STReaderDB';
        const DB_VERSION = 1;
        const STORE_CHATS = 'chats';
        let db = null;

        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => { db = request.result; resolve(db); };
                request.onupgradeneeded = (e) => {
                    const database = e.target.result;
                    if (!database.objectStoreNames.contains(STORE_CHATS)) {
                        database.createObjectStore(STORE_CHATS, { keyPath: 'id' });
                    }
                };
            });
        }

        async function saveChat(chatId, chatData) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_CHATS, 'readwrite');
                tx.objectStore(STORE_CHATS).put({ id: chatId, data: chatData });
                tx.oncomplete = resolve;
                tx.onerror = () => reject(tx.error);
            });
        }

        async function loadAllChats() {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_CHATS, 'readonly');
                const request = tx.objectStore(STORE_CHATS).getAll();
                request.onsuccess = () => {
                    const chats = {};
                    request.result.forEach(item => { chats[item.id] = item.data; });
                    resolve(chats);
                };
                request.onerror = () => reject(request.error);
            });
        }

        async function deleteChat(chatId) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_CHATS, 'readwrite');
                tx.objectStore(STORE_CHATS).delete(chatId);
                tx.oncomplete = resolve;
                tx.onerror = () => reject(tx.error);
            });
        }

        async function clearAllChats() {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_CHATS, 'readwrite');
                tx.objectStore(STORE_CHATS).clear();
                tx.oncomplete = resolve;
                tx.onerror = () => reject(tx.error);
            });
        }

        // ==================== é¢„è®¾ ====================
        const CSS_PRESETS = [
            { id: 'preset_default', name: 'é»˜è®¤æ·±è‰²', description: 'é»˜è®¤ä¸»é¢˜', css: `:root { --quote-color: #99cc99; --em-color: #ffcc00; --strong-color: #ff9966; }` },
            { id: 'preset_light', name: 'ç®€çº¦ç™½', description: 'æµ…è‰²æŠ¤çœ¼', css: `:root { --bg-primary: #f5f5f5; --bg-secondary: #ffffff; --bg-tertiary: #e8e8e8; --text-primary: #333; --text-secondary: #666; --user-bg: #e8f5e9; --char-bg: #fff3e0; --border-color: #ddd; --quote-color: #2e7d32; --em-color: #f57c00; --strong-color: #c62828; }` },
            { id: 'preset_novel', name: 'å°è¯´é˜…è¯»', description: 'çº¸è´¨é£æ ¼', css: `:root { --bg-primary: #f4ecd8; --bg-secondary: #fffef5; --bg-tertiary: #e8e0c8; --text-primary: #3a3228; --text-secondary: #6a6050; --accent: #8b4513; --user-bg: #e8f0e0; --char-bg: #fff8e8; } body { font-family: Georgia, serif; } .message-content { line-height: 2; }` },
            { id: 'preset_purple', name: 'æš—å¤œç´«', description: 'ç´«è‰²ä¸»é¢˜', css: `:root { --bg-primary: #1a1025; --bg-secondary: #2d1f3d; --bg-tertiary: #3d2a5a; --text-primary: #e8e0f0; --accent: #9b59b6; --user-bg: #2a3a4a; --char-bg: #4a2a5a; --quote-color: #a8e6cf; --em-color: #dda0dd; }` },
            { id: 'preset_ocean', name: 'æµ·æ´‹è“', description: 'æ¸…æ–°æµ·æ´‹', css: `:root { --bg-primary: #0a1628; --bg-secondary: #0f2540; --bg-tertiary: #1a3a5c; --text-primary: #e0f0ff; --accent: #00a8cc; --user-bg: #1a4a3a; --char-bg: #1a3a5a; --quote-color: #7fdbda; --em-color: #f7dc6f; }` }
        ];

        // ==================== çŠ¶æ€ ====================
        const state = {
            chats: {},
            currentChatId: null,
            currentPage: 1,
            pages: [],
            bookmarks: [],
            regexRules: [],
            cssSchemes: [],
            activeSchemeId: null,
            detectedTags: [],
            hiddenTags: new Set(),
            settings: {
                showUserMessages: true,
                showTimestamp: true,
                font: { family: '', size: 16, customUrl: '', loadedFonts: [] },
                background: ''
            },
            pendingBookmark: null
        };

        const STANDARD_HTML_TAGS = new Set([
            'html','head','body','div','span','p','a','img','br','hr',
            'h1','h2','h3','h4','h5','h6','ul','ol','li',
            'table','tr','td','th','thead','tbody',
            'strong','b','em','i','u','s','del','ins','sub','sup',
            'pre','code','blockquote','q','cite',
            'details','summary','header','footer','nav','main','section','article','aside',
            'figure','figcaption','style','script','form','input','button','select','option','textarea','label'
        ]);

        // ==================== DOM ====================
        const $ = id => document.getElementById(id);
        const els = {
            menuBtn: $('menuBtn'), settingsBtn: $('settingsBtn'), exportBtn: $('exportBtn'),
            sidebar: $('sidebar'), sidebarOverlay: $('sidebarOverlay'), settingsPanel: $('settingsPanel'),
            uploadZone: $('uploadZone'), fileInput: $('fileInput'),
            chatList: $('chatList'), bookmarkList: $('bookmarkList'), bookmarkCount: $('bookmarkCount'),
            cacheSize: $('cacheSize'), chat: $('chat'), welcomePage: $('welcomePage'),
            pagination: $('pagination'), prevBtn: $('prevBtn'), nextBtn: $('nextBtn'),
            pageInput: $('pageInput'), totalPages: $('totalPages'), toast: $('toast'),
            customCss: $('customCss'), customStylesheet: $('customStylesheet'),
            fontStylesheet: $('fontStylesheet'), customFontFaces: $('customFontFaces'),
            regexRules: $('regexRules'), tagFilters: $('tagFilters'),
            schemeList: $('schemeList'), currentSchemeName: $('currentSchemeName'),
            bookmarkPopup: $('bookmarkPopup'), popupOverlay: $('popupOverlay'),
            bookmarkNote: $('bookmarkNote'), previewSender: $('previewSender'), previewContent: $('previewContent'),
            fontPreviewText: $('fontPreviewText'), loadedFonts: $('loadedFonts'), fontTagsContainer: $('fontTagsContainer')
        };

        // ==================== åˆå§‹åŒ– ====================
        async function init() {
            try {
                await initDB();
                state.chats = await loadAllChats();
                loadSettings();
                bindEvents();
                renderAll();
                applyAllSettings();
                updateCacheStatus();
                reloadCustomFonts();
                const chatIds = Object.keys(state.chats);
                if (chatIds.length > 0) selectChat(chatIds[0]);
            } catch (e) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', e);
                showToast('âŒ åˆå§‹åŒ–å¤±è´¥');
            }
        }

        function loadSettings() {
            try {
                const saved = localStorage.getItem('st_reader_settings_v10');
                if (saved) {
                    const data = JSON.parse(saved);
                    state.bookmarks = data.bookmarks || [];
                    state.regexRules = data.regexRules || [];
                    state.cssSchemes = data.cssSchemes || [];
                    state.activeSchemeId = data.activeSchemeId || null;
                    state.hiddenTags = new Set(data.hiddenTags || []);
                    state.settings = { ...state.settings, ...data.settings };
                    if (!state.settings.font.loadedFonts) state.settings.font.loadedFonts = [];
                }
                if (state.cssSchemes.length === 0) {
                    state.cssSchemes.push({ id: 'default', name: 'é»˜è®¤', css: '' });
                    state.activeSchemeId = 'default';
                }
            } catch (e) { console.error(e); }
        }

        function saveSettings() {
            try {
                localStorage.setItem('st_reader_settings_v10', JSON.stringify({
                    bookmarks: state.bookmarks,
                    regexRules: state.regexRules,
                    cssSchemes: state.cssSchemes,
                    activeSchemeId: state.activeSchemeId,
                    hiddenTags: Array.from(state.hiddenTags),
                    settings: state.settings
                }));
            } catch (e) { console.error(e); }
        }

        async function updateCacheStatus() {
            let totalMessages = 0;
            const count = Object.keys(state.chats).length;
            Object.values(state.chats).forEach(chat => { totalMessages += chat.messages?.length || 0; });
            els.cacheSize.textContent = `${count} ä¸ªå¯¹è¯ / ${totalMessages} æ¡`;
        }

        function renderAll() {
            renderChatList();
            renderBookmarkList();
            renderRegexRules();
            renderSchemeList();
            renderTagFilters();
            loadActiveScheme();
            syncSettingsUI();
            renderLoadedFonts();
        }

        function applyAllSettings() {
            applyFont();
            applyBackground();
        }

        function syncSettingsUI() {
            $('showUserMessages').checked = state.settings.showUserMessages;
            $('showTimestamp').checked = state.settings.showTimestamp;
            $('systemFont').value = state.settings.font.family;
            $('fontSizeRange').value = state.settings.font.size;
            $('fontSizeValue').textContent = state.settings.font.size + 'px';
            $('bgImageUrl').value = state.settings.background || '';
            if (state.settings.font.customUrl) $('fontUrl').value = state.settings.font.customUrl;
        }

        // ==================== äº‹ä»¶ ====================
        function bindEvents() {
            els.menuBtn.addEventListener('click', toggleSidebar);
            els.sidebarOverlay.addEventListener('click', toggleSidebar);
            els.settingsBtn.addEventListener('click', toggleSettings);
            els.exportBtn.addEventListener('click', showExportModal);

            els.fileInput.addEventListener('change', handleFileSelect);
            els.uploadZone.addEventListener('dragover', e => { e.preventDefault(); els.uploadZone.classList.add('dragover'); });
            els.uploadZone.addEventListener('dragleave', e => { e.preventDefault(); els.uploadZone.classList.remove('dragover'); });
            els.uploadZone.addEventListener('drop', e => {
                e.preventDefault();
                els.uploadZone.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files).filter(f => f.name.endsWith('.jsonl'));
                if (files.length) processFiles(files);
            });

            els.prevBtn.addEventListener('click', () => changePage(-1));
            els.nextBtn.addEventListener('click', () => changePage(1));
            els.pageInput.addEventListener('change', handlePageInput);

            document.addEventListener('keydown', handleKeydown);

            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.dataset.tab));
            });

            $('showUserMessages').addEventListener('change', e => {
                state.settings.showUserMessages = e.target.checked;
                saveSettings();
                if (state.currentChatId) { buildPages(); renderCurrentPage(); }
            });

            $('showTimestamp').addEventListener('change', e => {
                state.settings.showTimestamp = e.target.checked;
                saveSettings();
                if (state.currentChatId) renderCurrentPage();
            });

            els.popupOverlay.addEventListener('click', closeBookmarkPopup);

            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', e => { if (e.target === overlay) overlay.classList.remove('open'); });
            });

            document.querySelectorAll('.format-option').forEach(opt => {
                opt.addEventListener('click', () => {
                    document.querySelectorAll('.format-option').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                    opt.querySelector('input').checked = true;
                });
            });

            document.querySelectorAll('input[name="exportRange"]').forEach(radio => {
                radio.addEventListener('change', updateExportPreview);
            });

            setupSwipeNavigation();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabName));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.toggle('active', content.id === `tab-${tabName}`));
        }

        function toggleSidebar() {
            els.sidebar.classList.toggle('open');
            els.sidebarOverlay.classList.toggle('open');
            els.settingsPanel.classList.remove('open');
        }

        function toggleSettings() {
            els.settingsPanel.classList.toggle('open');
            els.sidebar.classList.remove('open');
            els.sidebarOverlay.classList.remove('open');
        }

        // ==================== æ–‡ä»¶å¤„ç† ====================
        function handleFileSelect(e) { processFiles(Array.from(e.target.files)); }

        async function processFiles(files) {
            for (const file of files) {
                try {
                    const text = await file.text();
                    const lines = text.trim().split('\n');
                    const messages = [];
                    let chatMeta = null;

                    for (const line of lines) {
                        if (!line.trim()) continue;
                        try {
                            const obj = JSON.parse(line);
                            if (obj.chat_metadata) chatMeta = obj.chat_metadata;
                            else if (obj.name !== undefined) messages.push(obj);
                        } catch (e) {}
                    }

                    if (messages.length === 0) continue;

                    const chatIdHash = chatMeta?.chat_id_hash || generateHash(file.name + messages[0]?.send_date);
                    const charName = messages.find(m => !m.is_user)?.name || 'æœªçŸ¥è§’è‰²';

                    const chatData = { name: charName, file: file.name, messages, metadata: chatMeta };
                    state.chats[chatIdHash] = chatData;
                    await saveChat(chatIdHash, chatData);
                } catch (e) { console.error(e); }
            }

            renderChatList();
            detectAllTags();
            renderTagFilters();
            updateCacheStatus();

            const ids = Object.keys(state.chats);
            if (ids.length && !state.currentChatId) selectChat(ids[0]);
            showToast('âœ… å¯¼å…¥æˆåŠŸ');
        }

        function generateHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) { hash = ((hash << 5) - hash) + str.charCodeAt(i); hash = hash & hash; }
            return 'chat_' + Math.abs(hash).toString(16);
        }

        async function clearCache() {
            if (!confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰ç¼“å­˜ï¼Ÿ')) return;
            await clearAllChats();
            state.chats = {};
            state.currentChatId = null;
            state.pages = [];
            els.chat.innerHTML = '';
            els.chat.classList.remove('active');
            els.pagination.classList.add('hidden');
            els.welcomePage.style.display = 'block';
            els.exportBtn.style.display = 'none';
            renderChatList();
            updateCacheStatus();
            showToast('âœ… å·²æ¸…ç©º');
        }

        // ==================== æ ‡ç­¾æ£€æµ‹ä¸æ™ºèƒ½è¿‡æ»¤ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰====================
        function detectAllTags() {
            const allTags = new Set();
            for (const chatId of Object.keys(state.chats)) {
                for (const msg of state.chats[chatId].messages) {
                    detectTagsInText(msg.mes || '').forEach(tag => allTags.add(tag));
                }
            }
            state.detectedTags = Array.from(allTags).sort();
        }

        function detectTagsInText(text) {
            const tagRegex = /<\/?([a-zA-Z][a-zA-Z0-9_-]*)[^>]*>/g;
            const tags = new Set();
            let match;
            while ((match = tagRegex.exec(text)) !== null) {
                const tag = match[1].toLowerCase();
                if (!STANDARD_HTML_TAGS.has(tag)) tags.add(tag);
            }
            return Array.from(tags);
        }

        /**
         * æ™ºèƒ½è¿‡æ»¤æ ‡ç­¾å†…å®¹ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
         * - æ­£å¸¸é—­åˆï¼šåˆ é™¤ <tag>å†…å®¹</tag>
         * - åªæœ‰ç»“æŸæ ‡ç­¾ï¼šåˆ é™¤ä»æ¶ˆæ¯å¼€å¤´åˆ° </tag>
         * - åªæœ‰å¼€å§‹æ ‡ç­¾ï¼šåˆ é™¤ä» <tag> åˆ°ä¸‹ä¸€ä¸ªä»»æ„æ ‡ç­¾ä¹‹å‰
         */
        function filterTagContent(text, tag) {
            const tagLower = tag.toLowerCase();

            // åŒ¹é…å½“å‰æ ‡ç­¾çš„å¼€å§‹å’Œç»“æŸ
            const openTagRegex = new RegExp(`<${tagLower}(?:\\s[^>]*)?>`, 'gi');
            const closeTagRegex = new RegExp(`</${tagLower}>`, 'gi');

            // æ”¶é›†æ‰€æœ‰ç›®æ ‡æ ‡ç­¾ä½ç½®
            let openTags = [];
            let closeTags = [];
            let match;

            openTagRegex.lastIndex = 0;
            while ((match = openTagRegex.exec(text)) !== null) {
                openTags.push({ index: match.index, end: match.index + match[0].length, type: 'open' });
            }

            closeTagRegex.lastIndex = 0;
            while ((match = closeTagRegex.exec(text)) !== null) {
                closeTags.push({ index: match.index, end: match.index + match[0].length, type: 'close' });
            }

            if (openTags.length === 0 && closeTags.length === 0) {
                return text;
            }

            // æ”¶é›†æ‰€æœ‰ä»»æ„æ ‡ç­¾çš„å¼€å§‹ä½ç½®ï¼ˆç”¨äºç¡®å®šæœªé—­åˆå¼€å§‹æ ‡ç­¾çš„ç»“æŸç‚¹ï¼‰
            const anyTagStartRegex = /<[a-zA-Z][a-zA-Z0-9_-]*(?:\s[^>]*)?>/gi;
            const allTagStartPositions = [];
            anyTagStartRegex.lastIndex = 0;
            while ((match = anyTagStartRegex.exec(text)) !== null) {
                allTagStartPositions.push(match.index);
            }

            // æŒ‰ä½ç½®æ’åº
            const allTargetTags = [...openTags, ...closeTags].sort((a, b) => a.index - b.index);

            const removeRanges = [];
            const openStack = [];

            // å½“å‰è¦å¤„ç†çš„æ ‡ç­¾çš„å¼€å§‹ä½ç½®é›†åˆï¼ˆç”¨äºåé¢åˆ¤æ–­ï¼‰
            const currentTagOpenPositions = new Set(openTags.map(t => t.index));

            for (const tag of allTargetTags) {
                if (tag.type === 'open') {
                    openStack.push(tag);
                } else {
                    // ç»“æŸæ ‡ç­¾
                    if (openStack.length > 0) {
                        // æœ‰åŒ¹é…çš„å¼€å§‹æ ‡ç­¾
                        const openTag = openStack.pop();
                        removeRanges.push({ start: openTag.index, end: tag.end });
                    } else {
                        // æ²¡æœ‰åŒ¹é…çš„å¼€å§‹æ ‡ç­¾ - ä»æ–‡æœ¬å¼€å¤´åˆ°æ­¤ç»“æŸæ ‡ç­¾
                        removeRanges.push({ start: 0, end: tag.end });
                    }
                }
            }

            // å¤„ç†æœªé—­åˆçš„å¼€å§‹æ ‡ç­¾ï¼ˆä»å¼€å§‹æ ‡ç­¾åˆ°ä¸‹ä¸€ä¸ªéå½“å‰ç±»å‹æ ‡ç­¾ä¹‹å‰ï¼‰
            for (const openTag of openStack) {
                let nextTagPos = text.length; // é»˜è®¤åˆ°ç»“å°¾

                // æ‰¾åˆ°æ­¤å¼€å§‹æ ‡ç­¾ä¹‹åçš„ä¸‹ä¸€ä¸ªéå½“å‰æ ‡ç­¾ç±»å‹çš„æ ‡ç­¾
                for (const pos of allTagStartPositions) {
                    if (pos > openTag.index && !currentTagOpenPositions.has(pos)) {
                        nextTagPos = pos;
                        break;
                    }
                }

                removeRanges.push({ start: openTag.index, end: nextTagPos });
            }

            if (removeRanges.length === 0) {
                return text;
            }

            // åˆå¹¶é‡å åŒºé—´
            removeRanges.sort((a, b) => a.start - b.start);
            const mergedRanges = [removeRanges[0]];

            for (let i = 1; i < removeRanges.length; i++) {
                const last = mergedRanges[mergedRanges.length - 1];
                const current = removeRanges[i];
                if (current.start <= last.end) {
                    last.end = Math.max(last.end, current.end);
                } else {
                    mergedRanges.push(current);
                }
            }

            // ä»åå¾€å‰åˆ é™¤
            let result = text;
            for (let i = mergedRanges.length - 1; i >= 0; i--) {
                const range = mergedRanges[i];
                result = result.substring(0, range.start) + result.substring(range.end);
            }

            return result;
        }

        function refreshTags() {
            detectAllTags();
            renderTagFilters();
            showToast('âœ… å·²åˆ·æ–°');
        }

        function renderTagFilters() {
            if (state.detectedTags.length === 0) {
                els.tagFilters.innerHTML = '<span class="no-items-msg">æœªæ£€æµ‹åˆ°è‡ªå®šä¹‰æ ‡ç­¾</span>';
                return;
            }
            els.tagFilters.innerHTML = state.detectedTags.map(tag => {
                const isHidden = state.hiddenTags.has(tag);
                return `
                    <label class="tag-filter ${isHidden ? 'hidden-tag' : ''}">
                        <input type="checkbox" ${!isHidden ? 'checked' : ''} onchange="toggleTag('${tag}', this.checked)">
                        <span>&lt;${escapeHtml(tag)}&gt;</span>
                    </label>
                `;
            }).join('');
        }

        function toggleTag(tag, visible) {
            if (visible) state.hiddenTags.delete(tag);
            else state.hiddenTags.add(tag);
            saveSettings();
            renderTagFilters();
            if (state.currentChatId) renderCurrentPage();
        }

        // ==================== èŠå¤©åˆ—è¡¨ ====================
        function renderChatList() {
            const ids = Object.keys(state.chats);
            if (ids.length === 0) {
                els.chatList.innerHTML = '<li class="empty-state">æš‚æ— è®°å½•</li>';
                return;
            }
            els.chatList.innerHTML = ids.map(id => {
                const chat = state.chats[id];
                return `
                    <li class="${id === state.currentChatId ? 'active' : ''}" onclick="selectChat('${id}')">
                        <div class="list-item-header">
                            <div class="chat-info">
                                <div class="chat-name">${escapeHtml(chat.name)}</div>
                                <div class="chat-meta">${chat.messages.length} æ¡</div>
                            </div>
                            <button class="delete-btn" onclick="event.stopPropagation(); deleteChatItem('${id}')">ğŸ—‘ï¸</button>
                        </div>
                    </li>
                `;
            }).join('');
        }

        function selectChat(chatId) {
            state.currentChatId = chatId;
            state.currentPage = 1;
            buildPages();
            renderCurrentPage();
            renderChatList();
            els.welcomePage.style.display = 'none';
            els.exportBtn.style.display = 'flex';
            toggleSidebar();
        }

        async function deleteChatItem(chatId) {
            if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
            delete state.chats[chatId];
            await deleteChat(chatId);

            if (state.currentChatId === chatId) {
                state.currentChatId = null;
                state.pages = [];
                els.chat.innerHTML = '';
                els.chat.classList.remove('active');
                els.pagination.classList.add('hidden');
                els.exportBtn.style.display = 'none';

                const ids = Object.keys(state.chats);
                if (ids.length > 0) selectChat(ids[0]);
                else els.welcomePage.style.display = 'block';
            }

            state.bookmarks = state.bookmarks.filter(b => b.chatId !== chatId);
            saveSettings();
            renderChatList();
            renderBookmarkList();
            updateCacheStatus();
            detectAllTags();
            renderTagFilters();
        }

        // ==================== åˆ†é¡µ ====================
        function buildPages() {
            const chat = state.chats[state.currentChatId];
            if (!chat) return;

            state.pages = [];
            const messages = chat.messages;
            let i = 0;

            while (i < messages.length) {
                const page = [];
                if (messages[i]?.is_user) {
                    if (state.settings.showUserMessages) page.push(messages[i]);
                    i++;
                }
                while (i < messages.length && !messages[i]?.is_user) {
                    page.push(messages[i]);
                    i++;
                }
                if (page.length > 0) state.pages.push(page);
            }

            els.totalPages.textContent = state.pages.length;
            els.pagination.classList.toggle('hidden', state.pages.length === 0);
        }

        function renderCurrentPage() {
            if (state.pages.length === 0) {
                els.chat.classList.remove('active');
                return;
            }

            els.chat.classList.add('active');
            const page = state.pages[state.currentPage - 1] || [];

            els.chat.innerHTML = page.map((msg, idx) => {
                const isUser = msg.is_user;
                const content = processMessageContent(msg.mes || '');
                const time = state.settings.showTimestamp ? formatTime(msg.send_date) : '';
                const isBookmarked = state.bookmarks.some(b =>
                    b.chatId === state.currentChatId && b.page === state.currentPage && b.messageIndex === idx
                );

                return `
                    <div class="message ${isUser ? 'user' : 'char'}" data-page="${state.currentPage}" data-index="${idx}">
                        <div class="message-header">
                            <div class="message-header-left">
                                <span class="message-sender">${escapeHtml(msg.name || (isUser ? 'You' : 'Char'))}</span>
                                ${time ? `<span class="message-time">${time}</span>` : ''}
                            </div>
                            <div class="message-actions">
                                <button class="bookmark-btn ${isBookmarked ? 'bookmarked' : ''}"
                                        onclick="showBookmarkPopup(${state.currentPage}, ${idx})"
                                        title="${isBookmarked ? 'å·²æ”¶è—' : 'æ”¶è—'}">
                                    ${isBookmarked ? 'â˜…' : 'â˜†'}
                                </button>
                            </div>
                        </div>
                        <div class="message-content">${content}</div>
                    </div>
                `;
            }).join('');

            els.pageInput.value = state.currentPage;
            updatePaginationButtons();
            window.scrollTo(0, 0);
        }

        function processMessageContent(text, applyFilters = true) {
            // ç§»é™¤ HTML æ³¨é‡Š
            text = text.replace(/<!--[\s\S]*?-->/g, '');

            // åº”ç”¨æ­£åˆ™è§„åˆ™
            for (const rule of state.regexRules) {
                if (!rule.enabled || !rule.pattern) continue;
                try {
                    const regex = new RegExp(rule.pattern, rule.flags || 'g');
                    text = text.replace(regex, rule.replacement || '');
                } catch (e) {}
            }

            // åº”ç”¨æ ‡ç­¾è¿‡æ»¤ï¼ˆä½¿ç”¨æ™ºèƒ½è¿‡æ»¤å‡½æ•°ï¼‰
            if (applyFilters) {
                for (const tag of state.hiddenTags) {
                    text = filterTagContent(text, tag);
                }
            }

            // å®‰å…¨å¤„ç†
            const container = document.createElement('div');
            container.innerHTML = text;
            container.querySelectorAll('script, iframe, object, embed, form').forEach(el => el.remove());
            container.querySelectorAll('*').forEach(el => {
                Array.from(el.attributes).forEach(attr => {
                    if (attr.name.startsWith('on') || (attr.name === 'href' && attr.value.toLowerCase().startsWith('javascript:'))) {
                        el.removeAttribute(attr.name);
                    }
                });
            });

            processTextNodes(container);
            return container.innerHTML;
        }

        function processTextNodes(element) {
            const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT, null, false);
            const textNodes = [];
            while (walker.nextNode()) textNodes.push(walker.currentNode);

            textNodes.forEach(node => {
                const parent = node.parentNode;
                if (parent.closest('pre, code, script, style')) return;

                let text = node.textContent;
                let hasChanges = false;

                if (text.includes('`')) { text = text.replace(/`([^`]+)`/g, '<code>$1</code>'); hasChanges = true; }
                if (text.includes('~~')) { text = text.replace(/~~(.+?)~~/g, '<del>$1</del>'); hasChanges = true; }
                if (text.includes('*')) {
                    text = text.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
                    text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                    text = text.replace(/(?<![\\<])\*([^*\n]+)\*(?![>])/g, '<em>$1</em>');
                    hasChanges = true;
                }
                if (text.includes('"') || text.includes('ã€Œ') || text.includes('ã€')) {
                    text = text.replace(/"([^"]+)"/g, '<q>$1</q>');
                    text = text.replace(/ã€Œ([^ã€]+)ã€/g, '<q>$1</q>');
                    text = text.replace(/ã€([^ã€]+)ã€/g, '<q>$1</q>');
                    hasChanges = true;
                }
                if (text.includes('\n')) { text = text.replace(/\n/g, '<br>'); hasChanges = true; }

                if (hasChanges) {
                    const span = document.createElement('span');
                    span.innerHTML = text;
                    parent.replaceChild(span, node);
                }
            });
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            try {
                const date = new Date(typeof timestamp === 'number' ? timestamp : parseInt(timestamp) || timestamp);
                return isNaN(date.getTime()) ? '' : date.toLocaleString('zh-CN');
            } catch { return ''; }
        }

        function changePage(delta) {
            const newPage = state.currentPage + delta;
            if (newPage >= 1 && newPage <= state.pages.length) {
                state.currentPage = newPage;
                renderCurrentPage();
            }
        }

        function handlePageInput(e) {
            const page = parseInt(e.target.value);
            if (page >= 1 && page <= state.pages.length) { state.currentPage = page; renderCurrentPage(); }
            else e.target.value = state.currentPage;
        }

        function updatePaginationButtons() {
            els.prevBtn.disabled = state.currentPage <= 1;
            els.nextBtn.disabled = state.currentPage >= state.pages.length;
        }

        function handleKeydown(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            if (e.key === 'ArrowLeft' || e.key === 'a') changePage(-1);
            else if (e.key === 'ArrowRight' || e.key === 'd') changePage(1);
        }

        // ==================== æ”¶è— ====================
        function showBookmarkPopup(page, index) {
            const pageData = state.pages[page - 1];
            if (!pageData || !pageData[index]) return;

            const msg = pageData[index];
            const chat = state.chats[state.currentChatId];

            const existing = state.bookmarks.find(b => b.chatId === state.currentChatId && b.page === page && b.messageIndex === index);
            if (existing) {
                if (confirm('å·²æ”¶è—ï¼Œå–æ¶ˆï¼Ÿ')) {
                    state.bookmarks = state.bookmarks.filter(b => b.id !== existing.id);
                    saveSettings();
                    renderBookmarkList();
                    renderCurrentPage();
                    showToast('âœ… å·²å–æ¶ˆ');
                }
                return;
            }

            state.pendingBookmark = {
                chatId: state.currentChatId, chatName: chat.name, page, messageIndex: index,
                senderName: msg.name || (msg.is_user ? 'You' : 'Char'), content: msg.mes || ''
            };

            els.previewSender.textContent = state.pendingBookmark.senderName;
            els.previewContent.textContent = state.pendingBookmark.content.substring(0, 200) + (state.pendingBookmark.content.length > 200 ? '...' : '');
            els.bookmarkNote.value = '';

            els.popupOverlay.classList.add('show');
            els.bookmarkPopup.classList.add('show');
            els.bookmarkNote.focus();
        }

        function closeBookmarkPopup() {
            els.popupOverlay.classList.remove('show');
            els.bookmarkPopup.classList.remove('show');
            state.pendingBookmark = null;
        }

        function confirmBookmark() {
            if (!state.pendingBookmark) return;
            const bookmark = { id: Date.now().toString(), ...state.pendingBookmark, note: els.bookmarkNote.value.trim(), timestamp: new Date().toISOString() };
            state.bookmarks.unshift(bookmark);
            saveSettings();
            renderBookmarkList();
            renderCurrentPage();
            closeBookmarkPopup();
            showToast('â­ å·²æ”¶è—');
        }

        function renderBookmarkList() {
            els.bookmarkCount.textContent = state.bookmarks.length;
            if (state.bookmarks.length === 0) { els.bookmarkList.innerHTML = '<li class="empty-state">æš‚æ— æ”¶è—</li>'; return; }
            els.bookmarkList.innerHTML = state.bookmarks.map(b => `
                <li onclick="jumpToBookmark('${b.id}')">
                    <div class="list-item-header">
                        <div class="bookmark-info">
                            <div class="bookmark-title">${escapeHtml(b.chatName)} Â· P${b.page}</div>
                            <div class="bookmark-meta">${escapeHtml(b.senderName)}</div>
                        </div>
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteBookmarkItem('${b.id}')">ğŸ—‘ï¸</button>
                    </div>
                    <div class="bookmark-preview">${escapeHtml(b.content.substring(0, 60))}${b.content.length > 60 ? '...' : ''}</div>
                    ${b.note ? `<div class="bookmark-note">ğŸ“ ${escapeHtml(b.note)}</div>` : ''}
                </li>
            `).join('');
        }

        function jumpToBookmark(id) {
            const bookmark = state.bookmarks.find(b => b.id === id);
            if (!bookmark) return;
            if (!state.chats[bookmark.chatId]) { alert('å·²åˆ é™¤'); deleteBookmarkItem(id); return; }
            state.currentChatId = bookmark.chatId;
            buildPages();
            state.currentPage = Math.min(bookmark.page, state.pages.length);
            renderCurrentPage();
            renderChatList();
            els.welcomePage.style.display = 'none';
            toggleSidebar();
        }

        function deleteBookmarkItem(id) {
            state.bookmarks = state.bookmarks.filter(b => b.id !== id);
            saveSettings();
            renderBookmarkList();
            if (state.currentChatId) renderCurrentPage();
        }

        // ==================== æ»‘åŠ¨ ====================
        function setupSwipeNavigation() {
            let startX = 0, startY = 0, startTime = 0;
            els.chat.addEventListener('touchstart', e => { startX = e.touches[0].clientX; startY = e.touches[0].clientY; startTime = Date.now(); }, { passive: true });
            els.chat.addEventListener('touchend', e => {
                const deltaX = e.changedTouches[0].clientX - startX;
                const deltaY = e.changedTouches[0].clientY - startY;
                if (Date.now() - startTime < 300 && Math.abs(deltaX) > 50 && Math.abs(deltaX) > Math.abs(deltaY) * 1.5) {
                    changePage(deltaX > 0 ? -1 : 1);
                }
            }, { passive: true });
        }

        // ==================== å¯¼å‡º ====================
        function showExportModal() {
            if (!state.currentChatId) { showToast('è¯·å…ˆé€‰æ‹©èŠå¤©'); return; }
            $('exportPageEnd').value = state.pages.length;
            $('exportPageEnd').max = state.pages.length;
            $('exportPageStart').max = state.pages.length;
            updateExportPreview();
            $('exportModal').classList.add('open');
        }

        function updateExportPreview() {
            const chat = state.chats[state.currentChatId];
            if (!chat) return;
            const range = document.querySelector('input[name="exportRange"]:checked').value;
            let pageCount = 0, msgCount = 0;
            if (range === 'current') { pageCount = 1; msgCount = state.pages[state.currentPage - 1]?.length || 0; }
            else if (range === 'all') { pageCount = state.pages.length; state.pages.forEach(p => msgCount += p.length); }
            else {
                const start = parseInt($('exportPageStart').value) || 1;
                const end = parseInt($('exportPageEnd').value) || state.pages.length;
                pageCount = Math.max(0, end - start + 1);
                for (let i = start - 1; i < end && i < state.pages.length; i++) msgCount += state.pages[i]?.length || 0;
            }
            $('previewCharName').textContent = chat.name;
            $('previewPageCount').textContent = pageCount;
            $('previewMsgCount').textContent = msgCount;
        }

        function getExportPages() {
            const range = document.querySelector('input[name="exportRange"]:checked').value;
            if (range === 'current') return [state.pages[state.currentPage - 1]];
            if (range === 'all') return [...state.pages];
            const start = Math.max(1, parseInt($('exportPageStart').value) || 1);
            const end = Math.min(state.pages.length, parseInt($('exportPageEnd').value) || state.pages.length);
            const pages = [];
            for (let i = start - 1; i < end; i++) pages.push(state.pages[i]);
            return pages;
        }

        function executeExport() {
            const format = document.querySelector('input[name="exportFormat"]:checked').value;
            const chat = state.chats[state.currentChatId];
            const pages = getExportPages();
            const options = {
                includeTimestamp: $('exportIncludeTimestamp').checked,
                includeSenderName: $('exportIncludeSenderName').checked,
                applyFilters: $('exportApplyFilters').checked
            };
            closeModal('exportModal');
            switch (format) {
                case 'pdf': exportToPDF(chat, pages, options); break;
                case 'html': exportToHTML(chat, pages, options); break;
                case 'txt': exportToTXT(chat, pages, options); break;
                case 'md': exportToMarkdown(chat, pages, options); break;
                case 'json': exportToJSON(chat, pages, options); break;
                case 'epub': exportToEPUB(chat, pages, options); break;
            }
        }

        function exportToPDF(chat, pages, options) {
            const printContent = generateHTMLContent(chat, pages, options, true);
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.onload = () => { setTimeout(() => printWindow.print(), 500); };
            showToast('ğŸ“„ è¯·é€‰æ‹©"å¦å­˜ä¸ºPDF"');
        }

        function generateHTMLContent(chat, pages, options, forPrint = false) {
            const date = new Date().toLocaleDateString('zh-CN');
            let html = '';
            pages.forEach((page, i) => {
                if (i > 0 && forPrint) html += '<div style="page-break-before:always;"></div>';
                page.forEach(msg => {
                    const isUser = msg.is_user;
                    const content = processMessageContent(msg.mes || '', options.applyFilters);
                    const time = options.includeTimestamp ? formatTime(msg.send_date) : '';
                    const sender = options.includeSenderName ? (msg.name || (isUser ? 'You' : chat.name)) : '';
                    html += `<div class="message ${isUser ? 'user' : 'char'}">`;
                    if (sender || time) html += `<div class="message-header">${sender ? `<span class="message-sender">${escapeHtml(sender)}</span>` : ''}${time ? `<span class="message-time">${time}</span>` : ''}</div>`;
                    html += `<div class="message-content">${content}</div></div>`;
                });
            });
            return `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${escapeHtml(chat.name)}</title><style>*{margin:0;padding:0;box-sizing:border-box;}body{font-family:'Microsoft YaHei',sans-serif;line-height:1.8;padding:40px;max-width:800px;margin:0 auto;background:${forPrint?'white':'#1a1a2e'};color:${forPrint?'#333':'#eaeaea'};}.print-header{text-align:center;margin-bottom:40px;padding-bottom:20px;border-bottom:2px solid ${forPrint?'#333':'#e94560'};}.print-header h1{font-size:24px;color:${forPrint?'#333':'#e94560'};}.message{padding:15px 20px;margin-bottom:15px;border-radius:12px;}.message.user{background:${forPrint?'#e8f5e9':'#2d4a3e'};margin-left:20px;}.message.char{background:${forPrint?'#fff3e0':'#3d2a4a'};margin-right:20px;}.message-header{display:flex;justify-content:space-between;margin-bottom:10px;}.message-sender{font-weight:bold;color:${forPrint?'#333':'#e94560'};}.message-time{font-size:12px;color:${forPrint?'#666':'#a0a0a0'};}.message-content em{color:${forPrint?'#666':'#ffcc00'};}.message-content q{color:${forPrint?'#2e7d32':'#99cc99'};}.message-content q::before{content:'"';}.message-content q::after{content:'"';}.message-content strong{color:${forPrint?'#c62828':'#ff9966'};}@media print{.message{page-break-inside:avoid;}}</style></head><body><div class="print-header"><h1>${escapeHtml(chat.name)}</h1><div style="font-size:14px;color:${forPrint?'#666':'#a0a0a0'};">å¯¼å‡ºæ—¶é—´: ${date} | å…± ${pages.length} é¡µ</div></div>${html}</body></html>`;
        }

        function exportToHTML(chat, pages, options) {
            downloadFile(generateHTMLContent(chat, pages, options, false), `${chat.name}_èŠå¤©è®°å½•.html`, 'text/html');
            showToast('âœ… HTML å¯¼å‡ºæˆåŠŸ');
        }

        function exportToTXT(chat, pages, options) {
            let content = `${chat.name} - èŠå¤©è®°å½•\nå¯¼å‡º: ${new Date().toLocaleString('zh-CN')}\n${'='.repeat(50)}\n\n`;
            pages.forEach((page, i) => {
                content += `--- ç¬¬ ${i + 1} é¡µ ---\n\n`;
                page.forEach(msg => {
                    let text = msg.mes || '';
                    if (options.applyFilters) for (const tag of state.hiddenTags) text = filterTagContent(text, tag);
                    text = text.replace(/<[^>]+>/g, '').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&');
                    const sender = options.includeSenderName ? (msg.name || (msg.is_user ? 'You' : chat.name)) : '';
                    const time = options.includeTimestamp ? formatTime(msg.send_date) : '';
                    if (sender) content += `ã€${sender}ã€‘`;
                    if (time) content += ` ${time}`;
                    if (sender || time) content += '\n';
                    content += text.trim() + '\n\n';
                });
            });
            downloadFile(content, `${chat.name}_èŠå¤©è®°å½•.txt`, 'text/plain');
            showToast('âœ… TXT å¯¼å‡ºæˆåŠŸ');
        }

        function exportToMarkdown(chat, pages, options) {
            let content = `# ${chat.name}\n\n> å¯¼å‡º: ${new Date().toLocaleString('zh-CN')}\n\n---\n\n`;
            pages.forEach((page, i) => {
                content += `## ç¬¬ ${i + 1} é¡µ\n\n`;
                page.forEach(msg => {
                    let text = msg.mes || '';
                    if (options.applyFilters) for (const tag of state.hiddenTags) text = filterTagContent(text, tag);
                    text = text.replace(/<em>([^<]+)<\/em>/g, '*$1*').replace(/<strong>([^<]+)<\/strong>/g, '**$1**').replace(/<del>([^<]+)<\/del>/g, '~~$1~~').replace(/<code>([^<]+)<\/code>/g, '`$1`').replace(/<br\s*\/?>/g, '\n').replace(/<[^>]+>/g, '').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&');
                    const sender = options.includeSenderName ? (msg.name || (msg.is_user ? 'You' : chat.name)) : '';
                    const time = options.includeTimestamp ? formatTime(msg.send_date) : '';
                    if (sender) { content += `### ${sender}`; if (time) content += ` *${time}*`; content += '\n\n'; }
                    content += text.trim() + '\n\n';
                });
                content += '---\n\n';
            });
            downloadFile(content, `${chat.name}_èŠå¤©è®°å½•.md`, 'text/markdown');
            showToast('âœ… Markdown å¯¼å‡ºæˆåŠŸ');
        }

        function exportToJSON(chat, pages, options) {
            const data = { chatName: chat.name, exportDate: new Date().toISOString(), pageCount: pages.length, messages: [] };
            pages.forEach((page, i) => {
                page.forEach(msg => {
                    let content = msg.mes || '';
                    if (options.applyFilters) for (const tag of state.hiddenTags) content = filterTagContent(content, tag);
                    const entry = { page: i + 1, isUser: msg.is_user, content };
                    if (options.includeSenderName) entry.sender = msg.name || (msg.is_user ? 'You' : chat.name);
                    if (options.includeTimestamp && msg.send_date) entry.timestamp = msg.send_date;
                    data.messages.push(entry);
                });
            });
            downloadFile(JSON.stringify(data, null, 2), `${chat.name}_èŠå¤©è®°å½•.json`, 'application/json');
            showToast('âœ… JSON å¯¼å‡ºæˆåŠŸ');
        }

        function exportToEPUB(chat, pages, options) {
            let html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${escapeHtml(chat.name)}</title><style>*{margin:0;padding:0;box-sizing:border-box;}body{font-family:Georgia,serif;line-height:2;padding:40px;max-width:700px;margin:0 auto;background:#faf8f0;color:#333;}h1{text-align:center;margin-bottom:40px;color:#8b4513;}.chapter{margin-bottom:60px;}.chapter h2{color:#8b4513;border-bottom:1px solid #d4c4a8;padding-bottom:10px;margin-bottom:20px;}.message{margin-bottom:20px;padding:15px;border-radius:8px;}.message.user{background:#e8f0e0;}.message.char{background:#fff8e8;}.sender{font-weight:bold;color:#8b4513;margin-bottom:8px;}.content{text-align:justify;}.content em{color:#666;}.content q{color:#5d4e37;}.toc{margin-bottom:40px;padding:20px;background:#fff;border-radius:8px;}.toc h2{margin-bottom:15px;}.toc ul{list-style:none;}.toc li{padding:5px 0;}.toc a{color:#8b4513;text-decoration:none;}</style></head><body><h1>${escapeHtml(chat.name)}</h1><div class="toc"><h2>ç›®å½•</h2><ul>${pages.map((_, i) => `<li><a href="#chapter${i+1}">ç¬¬ ${i+1} é¡µ</a></li>`).join('')}</ul></div>`;
            pages.forEach((page, i) => {
                html += `<div class="chapter" id="chapter${i+1}"><h2>ç¬¬ ${i+1} é¡µ</h2>`;
                page.forEach(msg => {
                    const isUser = msg.is_user;
                    let text = processMessageContent(msg.mes || '', options.applyFilters);
                    const sender = options.includeSenderName ? (msg.name || (isUser ? 'You' : chat.name)) : '';
                    html += `<div class="message ${isUser ? 'user' : 'char'}">`;
                    if (sender) html += `<p class="sender">${escapeHtml(sender)}</p>`;
                    html += `<div class="content">${text}</div></div>`;
                });
                html += '</div>';
            });
            html += '</body></html>';
            downloadFile(html, `${chat.name}_ç”µå­ä¹¦.html`, 'text/html');
            showToast('âœ… ç”µå­ä¹¦å¯¼å‡ºæˆåŠŸ');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType + ';charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        // ==================== CSSæ–¹æ¡ˆ ====================
        function renderSchemeList() {
            els.schemeList.innerHTML = state.cssSchemes.map(s => `
                <li class="scheme-item ${s.id === state.activeSchemeId ? 'active' : ''}" onclick="activateScheme('${s.id}')">
                    <input type="radio" name="scheme" ${s.id === state.activeSchemeId ? 'checked' : ''}>
                    <div class="scheme-info"><div class="scheme-name">${escapeHtml(s.name)}</div></div>
                    ${s.id !== 'default' ? `<button class="delete-btn" onclick="event.stopPropagation(); deleteScheme('${s.id}')">ğŸ—‘ï¸</button>` : ''}
                </li>
            `).join('');
        }

        function activateScheme(id) { state.activeSchemeId = id; loadActiveScheme(); renderSchemeList(); saveSettings(); }

        function loadActiveScheme() {
            const s = state.cssSchemes.find(s => s.id === state.activeSchemeId);
            if (s) { els.customCss.value = s.css; els.currentSchemeName.textContent = s.name; els.customStylesheet.textContent = s.css; }
        }

        function applyAndSaveScheme() {
            const s = state.cssSchemes.find(s => s.id === state.activeSchemeId);
            if (s) { s.css = els.customCss.value; els.customStylesheet.textContent = s.css; saveSettings(); showToast('âœ… å·²ä¿å­˜'); }
        }

        function showNewSchemeModal() { $('newSchemeModal').classList.add('open'); $('newSchemeName').value = ''; }

        function createNewScheme() {
            const name = $('newSchemeName').value.trim();
            if (!name) return alert('è¯·è¾“å…¥åç§°');
            const s = { id: 'scheme_' + Date.now(), name, css: '' };
            state.cssSchemes.push(s);
            state.activeSchemeId = s.id;
            saveSettings(); renderSchemeList(); loadActiveScheme(); closeModal('newSchemeModal');
        }

        function deleteScheme(id) {
            if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
            state.cssSchemes = state.cssSchemes.filter(s => s.id !== id);
            if (state.activeSchemeId === id) { state.activeSchemeId = 'default'; loadActiveScheme(); }
            saveSettings(); renderSchemeList();
        }

        function exportCurrentScheme() {
            const s = state.cssSchemes.find(s => s.id === state.activeSchemeId);
            if (s) downloadJSON({ type: 'st_scheme', scheme: s }, `scheme_${s.name}.json`);
        }

        function importScheme() {
            const input = document.createElement('input');
            input.type = 'file'; input.accept = '.json,.css';
            input.onchange = async e => {
                try {
                    const file = e.target.files[0];
                    const text = await file.text();
                    let s;
                    if (file.name.endsWith('.css')) s = { id: 'scheme_' + Date.now(), name: file.name.replace('.css', ''), css: text };
                    else { const data = JSON.parse(text); s = { ...data.scheme, id: 'scheme_' + Date.now() }; }
                    state.cssSchemes.push(s); state.activeSchemeId = s.id;
                    saveSettings(); renderSchemeList(); loadActiveScheme(); showToast('âœ… å·²å¯¼å…¥');
                } catch (e) { alert('å¯¼å…¥å¤±è´¥'); }
            };
            input.click();
        }

        function loadPresets() {
            $('presetList').innerHTML = CSS_PRESETS.map(p => `
                <li class="scheme-item" onclick="applyPreset('${p.id}')">
                    <div class="scheme-info"><div class="scheme-name">${escapeHtml(p.name)}</div><div class="scheme-desc">${escapeHtml(p.description)}</div></div>
                </li>
            `).join('');
            $('presetsModal').classList.add('open');
        }

        function applyPreset(id) {
            const p = CSS_PRESETS.find(p => p.id === id);
            if (!p) return;
            const s = { id: 'scheme_' + Date.now(), name: p.name, css: p.css };
            state.cssSchemes.push(s); state.activeSchemeId = s.id;
            saveSettings(); renderSchemeList(); loadActiveScheme(); closeModal('presetsModal'); showToast(`âœ… å·²åº”ç”¨: ${p.name}`);
        }

        // ==================== å­—ä½“ ====================
        function applyFont() {
            const family = $('customFontName').value.trim() || $('systemFont').value || '';
            const size = parseInt($('fontSizeRange').value) || 16;
            state.settings.font.family = family; state.settings.font.size = size;
            let css = `:root { --SmartThemeFontSize: ${size}px; }`;
            if (family) { css += ` body { font-family: ${family}, var(--main-font) !important; }`; els.fontPreviewText.style.fontFamily = family; }
            else els.fontPreviewText.style.fontFamily = '';
            els.fontStylesheet.textContent = css;
            saveSettings();
        }

        function updateFontSize(val) { $('fontSizeValue').textContent = val + 'px'; els.fontPreviewText.style.fontSize = val + 'px'; applyFont(); }

        function loadWebFont() {
            const url = $('fontUrl').value.trim();
            if (!url) return alert('è¯·è¾“å…¥URL');
            const oldLink = document.querySelector('link[data-font-url]');
            if (oldLink) oldLink.remove();
            const link = document.createElement('link');
            link.rel = 'stylesheet'; link.href = url; link.dataset.fontUrl = url;
            document.head.appendChild(link);
            state.settings.font.customUrl = url;
            saveSettings(); showToast('âœ… å­—ä½“å·²åŠ è½½');
        }

        function uploadFont(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const fontName = 'CustomFont_' + file.name.replace(/\.[^.]+$/, '').replace(/[^a-zA-Z0-9]/g, '_');
                const fontData = e.target.result;
                const fontFace = new FontFace(fontName, `url(${fontData})`);
                fontFace.load().then(loaded => {
                    document.fonts.add(loaded);
                    if (!state.settings.font.loadedFonts) state.settings.font.loadedFonts = [];
                    if (!state.settings.font.loadedFonts.find(f => f.name === fontName)) {
                        state.settings.font.loadedFonts.push({ name: fontName, data: fontData });
                    }
                    updateFontFaces(); $('customFontName').value = fontName; applyFont(); renderLoadedFonts(); saveSettings();
                    showToast(`âœ… å­—ä½“ "${fontName}" å·²åŠ è½½`);
                }).catch(err => alert('åŠ è½½å¤±è´¥: ' + err.message));
            };
            reader.readAsDataURL(file);
        }

        function updateFontFaces() {
            let css = '';
            (state.settings.font.loadedFonts || []).forEach(f => { css += `@font-face { font-family: '${f.name}'; src: url(${f.data}); }`; });
            els.customFontFaces.textContent = css;
        }

        function reloadCustomFonts() {
            (state.settings.font.loadedFonts || []).forEach(font => {
                try { const ff = new FontFace(font.name, `url(${font.data})`); ff.load().then(l => document.fonts.add(l)).catch(() => {}); } catch (e) {}
            });
            updateFontFaces(); renderLoadedFonts();
            if (state.settings.font.customUrl) {
                const link = document.createElement('link');
                link.rel = 'stylesheet'; link.href = state.settings.font.customUrl;
                document.head.appendChild(link);
            }
        }

        function renderLoadedFonts() {
            const fonts = state.settings.font.loadedFonts || [];
            if (fonts.length === 0) { els.loadedFonts.style.display = 'none'; return; }
            els.loadedFonts.style.display = 'block';
            els.fontTagsContainer.innerHTML = fonts.map(f => `<span class="font-tag">${escapeHtml(f.name)}<button onclick="removeCustomFont('${f.name}')" style="background:none;border:none;color:var(--accent);cursor:pointer;margin-left:5px;">Ã—</button></span>`).join('');
        }

        function removeCustomFont(fontName) {
            state.settings.font.loadedFonts = (state.settings.font.loadedFonts || []).filter(f => f.name !== fontName);
            updateFontFaces(); renderLoadedFonts(); saveSettings(); showToast('âœ… å·²ç§»é™¤');
        }

        // ==================== èƒŒæ™¯ ====================
        function applyBackground() {
            const url = $('bgImageUrl').value.trim();
            state.settings.background = url;
            if (url) { document.body.style.backgroundImage = `url(${url})`; document.body.classList.add('has-bg'); }
            else { document.body.style.backgroundImage = ''; document.body.classList.remove('has-bg'); }
            saveSettings();
        }

        function clearBackground() { $('bgImageUrl').value = ''; applyBackground(); showToast('âœ… å·²æ¸…é™¤'); }

        // ==================== æ­£åˆ™ ====================
        function renderRegexRules() {
            if (state.regexRules.length === 0) { els.regexRules.innerHTML = '<p class="no-items-msg">æš‚æ— è§„åˆ™</p>'; return; }
            els.regexRules.innerHTML = state.regexRules.map((r, i) => `
                <div class="regex-rule">
                    <div class="rule-header"><span>è§„åˆ™ #${i + 1}</span><button class="delete-btn" onclick="deleteRegexRule(${i})">ğŸ—‘ï¸</button></div>
                    <label>æŸ¥æ‰¾:</label><textarea onchange="updateRegexRule(${i}, 'pattern', this.value)">${escapeHtml(r.pattern)}</textarea>
                    <label>æ›¿æ¢:</label><textarea onchange="updateRegexRule(${i}, 'replacement', this.value)">${escapeHtml(r.replacement)}</textarea>
                    <div class="rule-actions">
                        <label>æ ‡å¿—: <input type="text" class="flags-input" value="${escapeHtml(r.flags || 'g')}" onchange="updateRegexRule(${i}, 'flags', this.value)"></label>
                        <label><input type="checkbox" ${r.enabled ? 'checked' : ''} onchange="updateRegexRule(${i}, 'enabled', this.checked)"> å¯ç”¨</label>
                    </div>
                </div>
            `).join('');
        }

        function addRegexRule() { state.regexRules.push({ pattern: '', replacement: '', flags: 'g', enabled: true }); renderRegexRules(); saveSettings(); }
        function updateRegexRule(i, field, val) { if (state.regexRules[i]) { state.regexRules[i][field] = val; saveSettings(); } }
        function deleteRegexRule(i) { state.regexRules.splice(i, 1); renderRegexRules(); saveSettings(); if (state.currentChatId) renderCurrentPage(); }

        // ==================== æ•°æ® ====================
        function exportAllSettings() {
            downloadJSON({
                type: 'st_reader_settings_v10', bookmarks: state.bookmarks, regexRules: state.regexRules,
                cssSchemes: state.cssSchemes, activeSchemeId: state.activeSchemeId,
                hiddenTags: Array.from(state.hiddenTags), settings: state.settings
            }, `settings_${new Date().toISOString().slice(0,10)}.json`);
        }

        function importAllSettings() {
            const input = document.createElement('input');
            input.type = 'file'; input.accept = '.json';
            input.onchange = async e => {
                try {
                    const data = JSON.parse(await e.target.files[0].text());
                    Object.assign(state, {
                        bookmarks: data.bookmarks || [], regexRules: data.regexRules || [],
                        cssSchemes: data.cssSchemes || state.cssSchemes, activeSchemeId: data.activeSchemeId || state.activeSchemeId,
                        hiddenTags: new Set(data.hiddenTags || []), settings: { ...state.settings, ...data.settings }
                    });
                    saveSettings(); renderAll(); applyAllSettings(); reloadCustomFonts(); showToast('âœ… å·²å¯¼å…¥');
                } catch (e) { alert('å¯¼å…¥å¤±è´¥'); }
            };
            input.click();
        }

        async function clearAllData() {
            if (!confirm('ç¡®å®šæ¸…é™¤æ‰€æœ‰æ•°æ®ï¼Ÿ')) return;
            await clearAllChats();
            localStorage.removeItem('st_reader_settings_v10');
            location.reload();
        }

        // ==================== å·¥å…· ====================
        function escapeHtml(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
        }

        function showToast(msg) { els.toast.textContent = msg; els.toast.classList.add('show'); setTimeout(() => els.toast.classList.remove('show'), 2000); }
        function closeModal(id) { $(id).classList.remove('open'); }
        function downloadJSON(data, filename) { downloadFile(JSON.stringify(data, null, 2), filename, 'application/json'); }

        init();
    </script>
</body>
</html>